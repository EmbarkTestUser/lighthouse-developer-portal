name: Unit Tests

# Runs all tests using the `yarn test:all` command.
#
# Tests will be run for all packages along with showing test coverage

on:
  workflow_dispatch:
  workflow_call:

jobs:
  run-all-tests:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2.5.0
        with:
          node-version: 16
      - name: Install dependencies
        uses: ./.github/actions/install-dependencies
      - name: Test
        run: yarn test:all
      # Consolidate coverage results to single path
      - name: Consolidate coverage results
        run: |
          cp -r plugins/* packages
      - uses: actions/upload-artifact@v2
        with:
          name: logs
          path: |
            packages/*/coverage/lcov.info

  setup-matrix:
    runs-on: ubuntu-latest
    needs: run-all-tests
    outputs: 
      matrix: ${{ steps.matrix_string.outputs.matrix_string }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2.5.0
        with:
          node-version: 14
      - uses: actions/download-artifact@v2
        with:
          name: logs
          path: ./logs
      - name: Set up Matrix JSON object
        id: matrix_string
        run: |     
          matrix_string="["
          matrix_string+=$(find ./logs -maxdepth 1 -mindepth 1 -type d -printf '"%P", ')
          matrix_string=${matrix_string::-2}
          matrix_string+="]"
          echo ::set-output name=matrix_string::$matrix_string

  check-test-coverage:
    runs-on: ubuntu-latest
    needs: setup-matrix
    strategy:
      matrix:
        packages: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2.5.0
        with:
          node-version: 14
      - uses: actions/download-artifact@v2
        with:
          name: logs
          path: ./logs
      - name: Check coverage for ${{ matrix.packages }}
        if: matrix.packages != 'backend'
        uses: VeryGoodOpenSource/very_good_coverage@cfe8b79401ea7689953705f0d161cb51113f346f # pin@v1.2.0
        with:
          path: ./logs/${{ matrix.packages }}/coverage/lcov.info 
          min_coverage: 80
          exclude: '**/node_modules **/src/components **/src/hooks **/src/themes'